# Ä°pelya Abonelik & Ã–deme Sistemi - TODO List

Bu dokÃ¼man abonelik ve Ã¶deme sisteminin implementasyon adÄ±mlarÄ±nÄ± takip etmek iÃ§in kullanÄ±lÄ±r.

---

## ğŸ“Š Genel Ä°lerleme

| Faz                      | Durum             | Ä°lerleme |
| ------------------------ | ----------------- | -------- |
| Faz 1: VeritabanÄ±        | âœ… TamamlandÄ±      | 100%     |
| Faz 2: Edge Functions    | âœ… TamamlandÄ±      | 100%     |
| Faz 3: Frontend Services | âœ… TamamlandÄ±      | 95%      |
| Faz 4: UI Components     | âœ… TamamlandÄ±      | 95%      |
| Faz 5: Store Setup       | â³ **SENÄ°N SIRAN** | 0%       |
| Faz 6: Test & QA         | â³ Bekliyor        | 0%       |

---

## Faz 1: VeritabanÄ± ÅemasÄ±

### 1.1 Temel Tablolar (Coin Sistemi)
- [x] `coin_balances` tablosu oluÅŸtur âœ…
- [x] `purchases` tablosu oluÅŸtur âœ…
- [x] `coin_transactions` tablosu oluÅŸtur âœ…
- [x] `gifts` tablosu oluÅŸtur âœ…

### 1.2 Creator Abonelik TablolarÄ±
- [x] `creator_subscription_tiers` tablosu oluÅŸtur âœ…
  - [x] creator_id, name, description
  - [x] coin_price_monthly, coin_price_yearly
  - [x] benefits (JSONB), max_subscribers
  - [x] is_active, sort_order
- [x] `creator_subscriptions` tablosu oluÅŸtur âœ…
  - [x] subscriber_id, creator_id, tier_id
  - [x] status (active, paused, cancelled, expired)
  - [x] billing_period (monthly, yearly)
  - [x] coin_price, next_billing_at
- [x] `subscription_payments` tablosu oluÅŸtur âœ…
  - [x] subscription_id, coin_amount
  - [x] creator_share, platform_share

### 1.3 RLS Policies
- [x] `coin_balances` iÃ§in RLS policies âœ…
- [x] `purchases` iÃ§in RLS policies âœ…
- [x] `coin_transactions` iÃ§in RLS policies âœ…
- [x] `gifts` iÃ§in RLS policies âœ…
- [x] `creator_subscription_tiers` iÃ§in RLS policies âœ…
- [x] `creator_subscriptions` iÃ§in RLS policies âœ…
- [x] `subscription_payments` iÃ§in RLS policies âœ…

### 1.4 RPC FonksiyonlarÄ±
- [x] `decrement_coin_balance` fonksiyonu âœ…
- [x] `increment_coin_balance` fonksiyonu âœ…
- [ ] `transfer_coins` fonksiyonu (opsiyonel)

### 1.5 Indexler
- [x] `purchases(store, transaction_id)` unique index âœ…
- [x] `coin_transactions(user_id, created_at)` index âœ…
- [x] `gifts(sender_id)`, `gifts(receiver_id)` indexler âœ…
- [x] `creator_subscription_tiers(creator_id)` index âœ…
- [x] `creator_subscriptions(subscriber_id)` index âœ…
- [x] `creator_subscriptions(creator_id)` index âœ…
- [x] `creator_subscriptions(next_billing_at)` partial index (status = 'active') âœ…

---

## Faz 2: Supabase Edge Functions

### 2.1 SatÄ±n Alma DoÄŸrulama
- [x] `verify-purchase/index.ts` oluÅŸtur âœ…
  - [x] Apple receipt doÄŸrulama (TODO: implement actual validation)
  - [x] Google purchase token doÄŸrulama (TODO: implement actual validation)
  - [x] Duplicate check âœ…
  - [x] Coin grant logic âœ…

### 2.2 Mevcut Functions GÃ¼ncelleme
- [ ] `buy-coins/index.ts` gÃ¼ncelle (verify-purchase kullanÄ±lacak)

### 2.3 Hediye Sistemi
- [x] `send-gift/index.ts` oluÅŸtur âœ…
  - [x] Coin dÃ¼ÅŸÃ¼rme âœ…
  - [x] Gift kaydÄ± âœ…
  - [x] Creator payÄ± hesaplama âœ…
  - [x] Realtime broadcast âœ…

### 2.4 Creator Abonelik Functions
- [x] `subscribe-to-creator/index.ts` oluÅŸtur âœ…
  - [x] Tier bilgisi al âœ…
  - [x] Coin dÃ¼ÅŸÃ¼rme âœ…
  - [x] Creator payÄ± ekleme (%80) âœ…
  - [x] Abonelik kaydÄ± oluÅŸturma âœ…
  - [x] Ã–deme kaydÄ± oluÅŸturma âœ…
- [x] `cancel-creator-subscription/index.ts` oluÅŸtur âœ…
- [x] `manage-creator-tiers/index.ts` oluÅŸtur âœ…
  - [x] Tier oluÅŸturma (max 5) âœ…
  - [x] Tier gÃ¼ncelleme âœ…
  - [x] Tier silme (aktif abone yoksa) âœ…
- [x] `process-subscription-renewals/index.ts` oluÅŸtur (Cron) âœ…
  - [x] Yenilenmesi gereken abonelikleri bul âœ…
  - [x] Bakiye kontrol âœ…
  - [x] Yetersiz bakiye â†’ askÄ±ya al + bildirim âœ…
  - [x] Yeterli bakiye â†’ yenile âœ…

### 2.5 Webhook'lar
- [x] `webhook-apple/index.ts` - Apple Server Notifications v2 âœ…
- [x] `webhook-google/index.ts` - Google RTDN âœ…

### 2.6 YardÄ±mcÄ± Functions
- [x] `subscription-status/index.ts` - Abonelik durumu sorgulama âœ…
- [ ] `grant-tokens/index.ts` - Manuel token ekleme (admin bu next.js ops tarafÄ±nda yapÄ±lacak)
- [x] `get-creator-earnings/index.ts` - Creator gelir raporu âœ…

---

## Faz 3: Frontend Services (expo-iap)

> **Referans:** [expo-iap-rehberi.md](./expo-iap-rehberi.md)

### 3.1 expo-iap Kurulum
- [ ] `npx expo install expo-iap` Ã§alÄ±ÅŸtÄ±r
- [ ] Development build oluÅŸtur (Expo Go desteklenmez)
- [ ] iOS: `cd ios && pod install`
- [ ] Android: Billing permission kontrol et

### 3.2 ÃœrÃ¼n TanÄ±mlarÄ±
- [x] `apps/mobile/src/services/iap/products.ts` âœ…
  - [x] `COIN_PRODUCTS` array (id, coins, bonus) âœ…
  - [x] `SUBSCRIPTION_PRODUCTS` array (id, period) âœ…
  - [x] `CoinProductId` type âœ…
  - [x] `SubscriptionProductId` type âœ…

### 3.3 Hooks (useIAP tabanlÄ±)
- [x] `apps/mobile/src/hooks/usePurchase.ts` âœ…
  - [x] `useIAP` hook entegrasyonu âœ…
  - [x] `connected` state kontrolÃ¼ âœ…
  - [x] `requestProducts()` - Ã¼rÃ¼n yÃ¼kleme âœ…
  - [x] `requestPurchase()` - satÄ±n alma (iOS/Android unified API) âœ…
  - [x] `currentPurchase` listener âœ…
  - [x] `currentPurchaseError` handler âœ…
  - [x] `finishTransaction()` - transaction tamamlama âœ…
  - [x] `getAvailablePurchases()` - restore âœ…
  - [x] Error handling (E_USER_CANCELLED, E_NETWORK_ERROR, vb.) âœ…
- [x] `apps/mobile/src/hooks/useTokenBalance.ts` âœ…
- [x] `apps/mobile/src/hooks/useGiftSend.ts` âœ…
- [x] `apps/mobile/src/hooks/useGiftNotifications.ts` âœ…

### 3.4 Creator Abonelik Hooks
- [x] `apps/mobile/src/hooks/useCreatorSubscription.ts` âœ…
  - [x] `subscribe()` - abonelik baÅŸlatma âœ…
  - [x] `cancel()` - abonelik iptal âœ…
  - [x] `getMySubscriptions()` - kullanÄ±cÄ±nÄ±n abonelikleri âœ…
- [x] `apps/mobile/src/hooks/useCreatorTiers.ts` âœ…
  - [x] `createTier()` - tier oluÅŸturma âœ…
  - [x] `updateTier()` - tier gÃ¼ncelleme âœ…
  - [x] `deleteTier()` - tier silme âœ…
  - [x] `getMyTiers()` - creator'Ä±n tier'larÄ± âœ…
- [x] `apps/mobile/src/hooks/useCreatorEarnings.ts` âœ…
  - [x] Gelir istatistikleri âœ…
  - [x] Abone sayÄ±sÄ± âœ…

### 3.5 Store (Zustand)
- [x] `apps/mobile/src/store/economy.store.ts` âœ…
  - [x] `balance` state âœ…
  - [x] `subscription` state (hooks iÃ§inde) âœ…
  - [x] `refreshBalance()` action âœ…
  - [x] `refreshSubscription()` action (hooks iÃ§inde) âœ…

### 3.6 Types
- [x] `packages/types/src/economy.ts` gÃ¼ncelle âœ…
  - [x] `CoinBalance` type âœ…
  - [x] `Purchase` type âœ…
  - [x] `CoinTransaction` type âœ…
  - [x] `Gift` type âœ…
  - [x] `Product` type (expo-iap) âœ…
  - [x] `CreatorSubscriptionTier` type âœ…
  - [x] `CreatorSubscription` type âœ…
  - [x] `SubscriptionPayment` type âœ…

### 3.7 Kritik Kontroller
- [x] `finishTransaction` her baÅŸarÄ±lÄ± satÄ±n almada Ã§aÄŸrÄ±lÄ±yor mu? âœ…
- [x] Server-side validation yapÄ±lÄ±yor mu? âœ…
- [ ] Pending purchases app baÅŸlangÄ±cÄ±nda kontrol ediliyor mu?
- [x] Error handling tÃ¼m case'leri kapsÄ±yor mu? âœ…

---

## Faz 4: UI Components  (ModÃ¼ler olarak component bazlÄ± geliÅŸtir, dosyalar Ã§ok uzunsa componentlere bÃ¶l.)

### 4.1 Store EkranÄ±
- [ ] `apps/mobile/app/(store)/index.tsx` - Ana maÄŸaza ekranÄ±
- [ ] `apps/mobile/app/(store)/coins.tsx` - Coin satÄ±n alma
- [ ] `apps/mobile/app/(store)/subscription.tsx` - Abonelik

### 4.2 Store Components
- [x] `apps/mobile/src/components/store/CoinPackageCard.tsx` âœ…
- [x] `apps/mobile/src/components/store/SubscriptionCard.tsx` âœ…
- [x] `apps/mobile/src/components/store/PurchaseButton.tsx` âœ…
- [x] `apps/mobile/src/components/store/BalanceDisplay.tsx` âœ…

### 4.3 Hediye Components
- [x] `apps/mobile/src/components/store/GiftSelector.tsx` âœ…
- [x] `apps/mobile/src/components/store/GiftModal.tsx` âœ…

### 4.4 Animasyonlar (React Native Animated)
- [x] `apps/mobile/src/components/store/GiftAnimations/index.tsx` âœ…
- [x] `apps/mobile/src/components/store/GiftAnimations/HeartBurst.tsx` âœ…
- [x] `apps/mobile/src/components/store/GiftAnimations/DiamondRain.tsx` âœ…
- [x] `apps/mobile/src/components/store/GiftAnimations/CrystalExplosion.tsx` âœ…
- [x] `apps/mobile/src/components/store/GiftAnimations/GiftAnimationOverlay.tsx` âœ…

### 4.5 Creator Abonelik UI
- [x] `apps/mobile/src/components/creator/TierCard.tsx` - Tier kartÄ± âœ…
- [x] `apps/mobile/src/components/creator/TierEditor.tsx` - Tier dÃ¼zenleme âœ…
- [x] `apps/mobile/src/components/creator/SubscribeModal.tsx` - Abone olma modal âœ…
- [x] `apps/mobile/src/components/creator/SubscribersList.tsx` - Abone listesi âœ…
- [x] `apps/mobile/src/components/creator/EarningsCard.tsx` - Gelir kartÄ± âœ…

### 4.6 Creator Dashboard EkranlarÄ±
- [x] `apps/mobile/app/(creator)/tiers.tsx` - Tier yÃ¶netimi âœ…
- [x] `apps/mobile/app/(creator)/subscribers.tsx` - Abone listesi âœ…
- [x] `apps/mobile/app/(creator)/earnings.tsx` - Gelir raporu âœ…

### 4.7 Profil Entegrasyonu
- [ ] Profil ekranÄ±na coin bakiyesi ekle
- [ ] Profil ekranÄ±na abonelik durumu ekle
- [ ] Creator profiline hediye gÃ¶nder butonu ekle
- [ ] Creator profiline abonelik tier'larÄ± ekle
- [ ] Creator profiline "Abone Ol" butonu ekle

---

## Faz 5: Store Setup

### 5.1 Apple App Store Connect
- [ ] In-App Purchases oluÅŸtur
  - [ ] `ipelya_coins_100` (Consumable)
  - [ ] `ipelya_coins_500` (Consumable)
  - [ ] `ipelya_coins_1000` (Consumable)
- [ ] Subscriptions oluÅŸtur
  - [ ] `ipelya_premium_monthly` (Auto-Renewable)
  - [ ] `ipelya_premium_yearly` (Auto-Renewable)
- [ ] Server Notifications v2 webhook URL ayarla
- [ ] Sandbox test hesaplarÄ± oluÅŸtur

### 5.2 Google Play Console
- [ ] In-app products oluÅŸtur
  - [ ] `ipelya_coins_100`
  - [ ] `ipelya_coins_500`
  - [ ] `ipelya_coins_1000`
- [ ] Subscriptions oluÅŸtur
  - [ ] `ipelya_premium_monthly`
  - [ ] `ipelya_premium_yearly`
- [ ] Real-time Developer Notifications (RTDN) ayarla
- [ ] License test hesaplarÄ± ekle

### 5.3 API Credentials
- [ ] Apple App Store Connect API key oluÅŸtur
- [ ] Google Play Developer API service account oluÅŸtur
- [ ] Supabase secrets'a ekle:
  - [ ] `APPLE_SHARED_SECRET`
  - [ ] `APPLE_ISSUER_ID`
  - [ ] `APPLE_KEY_ID`
  - [ ] `APPLE_PRIVATE_KEY`
  - [ ] `GOOGLE_SERVICE_ACCOUNT_KEY`

---

## Faz 6: Test & QA

### 6.1 Unit Tests
- [ ] IAP service tests
- [ ] Economy store tests
- [ ] Hook tests

### 6.2 Integration Tests
- [ ] Purchase flow test (sandbox)
- [ ] Gift send/receive test
- [ ] Subscription flow test

### 6.3 Edge Function Tests
- [ ] verify-purchase tests
- [ ] send-gift tests
- [ ] webhook tests

### 6.4 E2E Tests
- [ ] Coin satÄ±n alma akÄ±ÅŸÄ±
- [ ] Platform abonelik satÄ±n alma akÄ±ÅŸÄ±
- [ ] Creator abonelik akÄ±ÅŸÄ±
- [ ] Hediye gÃ¶nderme akÄ±ÅŸÄ±
- [ ] Bakiye gÃ¶rÃ¼ntÃ¼leme
- [ ] Creator tier yÃ¶netimi

### 6.5 Security Tests
- [ ] Receipt replay attack test
- [ ] Double-spend test
- [ ] Rate limiting test
- [ ] Creator abonelik fraud test

### 6.6 Cron Job Tests
- [ ] `process-subscription-renewals` test
  - [ ] Yenileme baÅŸarÄ±lÄ±
  - [ ] Yetersiz bakiye â†’ askÄ±ya alma
  - [ ] Bildirim gÃ¶nderimi

---

## ğŸ“ Notlar

### Ã–ncelik SÄ±rasÄ±
1. **YÃ¼ksek:** VeritabanÄ± ÅŸemasÄ±, verify-purchase, buy-coins, creator abonelik tablolarÄ±
2. **Orta:** Hediye sistemi, Creator abonelik functions, UI components
3. **DÃ¼ÅŸÃ¼k:** Animasyonlar, Creator dashboard, gelir raporlarÄ±

### BaÄŸÄ±mlÄ±lÄ±klar
- Faz 2 â†’ Faz 1 tamamlanmalÄ±
- Faz 3 â†’ Faz 2 tamamlanmalÄ±
- Faz 4 â†’ Faz 3 tamamlanmalÄ±
- Faz 5 â†’ Faz 2 tamamlanmalÄ± (parallel Ã§alÄ±ÅŸabilir)
- Faz 6 â†’ TÃ¼m fazlar tamamlanmalÄ±

### Tahmini SÃ¼re
| Faz        | SÃ¼re          | Notlar                             |
| ---------- | ------------- | ---------------------------------- |
| Faz 1      | 2-3 gÃ¼n       | Creator abonelik tablolarÄ± eklendi |
| Faz 2      | 3-4 gÃ¼n       | Creator abonelik functions eklendi |
| Faz 3      | 3-4 gÃ¼n       | Creator hooks eklendi              |
| Faz 4      | 4-5 gÃ¼n       | Creator UI components eklendi      |
| Faz 5      | 1-2 gÃ¼n       | Store setup                        |
| Faz 6      | 2-3 gÃ¼n       | Test & QA                          |
| **Toplam** | **15-21 gÃ¼n** |

---

## ğŸ“š Ä°lgili DÃ¶kÃ¼manlar

| DÃ¶kÃ¼man                                                                    | AÃ§Ä±klama                           |
| -------------------------------------------------------------------------- | ---------------------------------- |
| [abonelik-dokumasyon.md](./abonelik-dokumasyon.md)                         | Ana implementasyon rehberi         |
| [expo-iap-rehberi.md](./expo-iap-rehberi.md)                               | expo-iap detaylÄ± kullanÄ±m kÄ±lavuzu |
| [teknik-analiz-iap-kutuphaneleri.md](./teknik-analiz-iap-kutuphaneleri.md) | KÃ¼tÃ¼phane karÅŸÄ±laÅŸtÄ±rmasÄ±          |

---

## ğŸ”„ GÃ¼ncelleme GeÃ§miÅŸi

| Tarih      | GÃ¼ncelleme                                                                                        |
| ---------- | ------------------------------------------------------------------------------------------------- |
| 2025-11-25 | Ä°lk versiyon oluÅŸturuldu                                                                          |
| 2025-11-25 | expo-iap detaylarÄ± eklendi, useIAP hook entegrasyonu                                              |
| 2025-11-25 | Creator abonelik sistemi eklendi (tier yÃ¶netimi, dinamik fiyatlandÄ±rma)                           |
| 2025-11-25 | **Faz 1-4 implementasyonu tamamlandÄ±** - DB ÅŸemasÄ±, Edge Functions, Frontend Hooks, UI Components |
